#!/bin/sh
set -e
set -x

mkdir -p /srv/builds
mkdir -p /srv/jekyll
/opt/jekyll/bin/gem update --system
/opt/jekyll/bin/gem update --no-document
/opt/jekyll/bin/gem clean

gem update --system
gem update --no-document
gem clean

maj=$(/opt/jekyll/bin/ruby -e 'puts `sudo /opt/jekyll/bin/jekyll -v |cut -d" " -f2`.split(".")[0]')
min=$(/opt/jekyll/bin/ruby -e 'puts `sudo /opt/jekyll/bin/jekyll -v |cut -d" " -f2`.split(".")[1]')
rev=$(/opt/jekyll/bin/ruby -e 'puts `sudo /opt/jekyll/bin/jekyll -v |cut -d" " -f2`.split(".")[2]')
ver=$(/opt/jekyll/bin/jekyll -v |cut -d" " -f2)

mkdir -p /srv/builds/opt && cp -R /opt/jekyll /srv/builds/opt
/opt/fpm/bin/fpm -s dir -t deb -n jekyll${maj} -v ${ver}-${min}jekyll${rev} \
    --maintainer "Jordon Bedwell <jordon@envygeeks.io>" \
    --after-install /srv/fpm/shared/install.sh \
    --after-remove /srv/fpm/shared/remove.sh \
    --description "Jekyll ${ver}" \
    --url https://jekyllrb.com \
    --vendor "Jekyll Core Team" \
    --license MIT \
    --provides jekyll \
    --provides jekyll${ver} \
    --provides jekyll${maj} \
    --depends libc6 \
    --depends libffi6  \
    --depends libgdbm3 \
    --depends libncurses5 \
    --depends libreadline6 \
    --depends libssl1.0.0 \
    --depends libyaml-0-2 \
    --depends zlib1g \
    -p /srv/jekyll \
    -C /srv/builds ./
