#!/bin/bash -ex

source /usr/share/envygeeks/helpers.bash
addpkgs build-essential libxml2-dev libxslt1-dev libffi-dev libyaml-dev \
  libreadline6-dev \ python python-chardet python-pkg-resources python-pygments

groupadd -rg 1000 jekyll
useradd  -u  1000 -g 1000 \
  -rMd /home/jekyll jekyll

cd ~
yes | gem update --system --no-document
yes | gem update --no-document
yes | gem install jekyll -v ${JEKYLL_VERSION} --no-document
yes | gem install therubyracer bundler --no-document
yes | gem install RedCloth --no-document
yes | gem install pry --no-document

# -----------------------------------------------------------------------------
# Any default plugins we want to include go here!
# -----------------------------------------------------------------------------

yes | gem install jekyll-sitemap --no-document

# -----------------------------------------------------------------------------

gem clean
rm -rf /opt/jekyll/lib/ruby/gems/2.2.0/cache/*
rm -rf ~/.gem

echo python               hold | dpkg --set-selections
echo python-chardet       hold | dpkg --set-selections
echo python-pkg-resources hold | dpkg --set-selections
echo python-pygments      hold | dpkg --set-selections

cleanpkgs build-essential libxml2-dev libxslt1-dev libffi-dev libyaml-dev \
  libreadline6-dev

createdir jekyll.jekyll /home/jekyll
createdir jekyll.jekyll /srv/jekyll

cp ~/.bashrc /home/jekyll/.bashrc
chown jekyll.jekyll /home/jekyll/.bashrc
echo 'jekyll ALL=NOPASSWD:ALL' >> /etc/sudoers
sudo -u jekyll jekyll new /srv/jekyll
